name: Release Please version bump changelog
description: |
  Bump version and generate changelog using release-please.
  Trigger with workflow_dispatch
  release-please-action will automatically use the following commit message prefixes to determine the version bump:
  - feat: Minor
  - fix: Patch
  - BREAKING CHANGE: Major
  - anything else: No bump
  Set .release-please-config.json to customize github draft release, changelog omissions, headers

inputs:
  release-type:
    description: "Release type for release-please (node, simple, etc.)"
    required: false
    default: "node"
    type: string
  target-branch:
    description: "Target branch for releases"
    required: false
    default: "main"
    type: string
  config-file:
    description: "Path to release-please config file"
    required: false
    default: "release-please-config.json"
    type: string
  manifest-file:
    description: "Path to release-please manifest file"
    required: false
    default: ".release-please-manifest.json"
    type: string
  skip-github-release:
    description: "Create GitHub draft release"
    required: false
    default: false
    type: boolean
  skip-github-pull-request:
    description: "Skip creating a GitHub pull request"
    required: false
    default: false
    type: boolean

runs:
  using: composite
  steps:
    - name: Get secrets from Vault
      id: get-secrets
      uses: grafana/shared-workflows/actions/get-vault-secrets@9f37f656e063f0ad0b0bfc38d49894b57d363936
      env:
        VAULT_INSTANCE: ops
      with:
        vault_instance: ${{ env.VAULT_INSTANCE }}
        common_secrets: |
          GITHUB_APP_ID=plugins-platform-bot-app:app-id
          GITHUB_APP_PRIVATE_KEY=plugins-platform-bot-app:private-key
        export_env: false

    - name: Generate GitHub token
      id: generate-github-token
      uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e
      with:
        app-id: ${{ fromJSON(steps.get-secrets.outputs.secrets).GITHUB_APP_ID }}
        private-key: ${{ fromJSON(steps.get-secrets.outputs.secrets).GITHUB_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}

    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ steps.generate-github-token.outputs.token }}
        persist-credentials: true
        fetch-depth: 0

    - name: Configure Git
      shell: bash
      run: |
        git config user.name 'grafana-plugins-platform-bot[bot]'
        git config user.email '144369747+grafana-plugins-platform-bot[bot]@users.noreply.github.com'

    - name: Run automatic release-please
      working-directory: ${{ github.workspace }}
      uses: googleapis/release-please-action@a02a34c4d625f9be7cb89156071d8567266a2445 # v4.2.0
      with:
        release-type: ${{ inputs.release-type }}
        config-file: ${{ inputs.config-file }}
        manifest-file: ${{ inputs.manifest-file }}
        skip-github-pull-request: ${{ inputs.skip-github-pull-request }}
        skip-github-release: ${{ inputs.skip-github-release }}
        token: ${{ steps.generate-github-token.outputs.token }}
        target-branch: ${{ inputs.target-branch || github.ref_name }}
