name: Release Please version bump changelog
description: |
  Bump version and generate changelog using release-please.
  Trigger with workflow_dispatch.
  Downloads config + manifest via curl into predictable filenames.
  Commit message prefixes used:
  - feat: Minor
  - fix: Patch
  - BREAKING CHANGE: Major
  - anything else: No bump

inputs:
  target-branch:
    description: "Branch to release from"
    required: false
    default: "main"
    type: string

  repo-url:
    description: "Repository to run release-please on"
    required: false
    default: ${{ github.repository }}
    type: string

  config-url:
    description: "URL to release-please-config.json"
    required: false
    default: "https://raw.githubusercontent.com/grafana/test-release-gh-actions/main/release-please-config.json"
    type: string

  manifest-url:
    description: "URL to .release-please-manifest.json"
    required: false
    default: "https://raw.githubusercontent.com/grafana/test-release-gh-actions/main/.release-please-manifest.json"
    type: string

runs:
  using: composite
  steps:
    - name: Get secrets from Vault
      id: get-secrets
      uses: grafana/shared-workflows/actions/get-vault-secrets@9f37f656e063f0ad0b0bfc38d49894b57d363936
      env:
        VAULT_INSTANCE: ops
      with:
        vault_instance: ${{ env.VAULT_INSTANCE }}
        common_secrets: |
          GITHUB_APP_ID=plugins-platform-bot-app:app-id
          GITHUB_APP_PRIVATE_KEY=plugins-platform-bot-app:private-key
        export_env: false

    - name: Generate GitHub token
      id: generate-github-token
      uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e
      with:
        app-id: ${{ fromJSON(steps.get-secrets.outputs.secrets).GITHUB_APP_ID }}
        private-key: ${{ fromJSON(steps.get-secrets.outputs.secrets).GITHUB_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}

    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        token: ${{ steps.generate-github-token.outputs.token }}
        persist-credentials: true
        fetch-depth: 0

    - name: Configure Git
      shell: bash
      run: |
        git config user.name 'grafana-plugins-platform-bot[bot]'
        git config user.email '144369747+grafana-plugins-platform-bot[bot]@users.noreply.github.com'

    - name: Install release-please
      shell: bash
      run: npm install -g release-please

    - name: Download config + manifest
      shell: bash
      run: |
        echo "Fetching config from: ${{ inputs.config-url }}"
        curl -fsSL "${{ inputs.config-url }}" -o release-please-config.json

        echo "Fetching manifest from: ${{ inputs.manifest-url }}"
        curl -fsSL "${{ inputs.manifest-url }}" -o .release-please-manifest.json

        echo "Downloaded files:"
        ls -l release-please-config.json .release-please-manifest.json

    - name: Run release-please
      shell: bash
      run: |
        release-please release-pr \
          --repo-url="${{ inputs.repo-url }}" \
          --token="${{ steps.generate-github-token.outputs.token }}" \
          --target-branch="${{ inputs.target-branch || github.ref_name }}" \
          --config-file="release-please-config.json" \
          --manifest-file=".release-please-manifest.json"
