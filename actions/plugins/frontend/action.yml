name: Plugins - Frontend - Test and build
description: Tests, lints, typechecks and builds the frontend.

inputs:
  plugin-directory:
    description: Directory of the plugin, if not in the root of the repository.
    required: false
    default: .
  secrets:
    required: false
    type: string
    description: The secrets to use within frontend steps
  npm-registry-auth:
    description: |
      Whether to authenticate to the npm registry in Google Artifact Registry.
      If true, the root of the plugin repository must contain a `.npmrc` file.
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - name: Get secrets from Vault
      if: inputs.secrets != ''
      id: get-secrets
      uses: grafana/shared-workflows/actions/get-vault-secrets@a37de51f3d713a30a9e4b21bcdfbd38170020593 # get-vault-secrets/v1.3.0
      with:
        repo_secrets: ${{ inputs.secrets }}

    - name: Login to Google Cloud
      if: inputs.npm-registry-auth == 'true'
      uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
      with:
        token_format: access_token
        workload_identity_provider: "projects/304398677251/locations/global/workloadIdentityPools/github/providers/github-provider"
        service_account: github-plugin-ci-workflows@grafanalabs-workload-identity.iam.gserviceaccount.com

    - name: NPM registry auth
      if: inputs.npm-registry-auth == 'true'
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: GOOGLE_APPLICATION_CREDENTIALS=${{ env.GOOGLE_APPLICATION_CREDENTIALS }} npx google-artifactregistry-auth --credential-config ./.npmrc

    - name: Detect package manager
      id: node-pm
      # TODO: Fix this once we have a version of the package-manager-detect action
      uses: grafana/plugin-actions/package-manager-detect@jackw/pm-detect # zizmor: ignore[unpinned-uses]
      with:
        working-directory: ${{ inputs.plugin-directory }}

    - name: Install dependencies
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: ${{ steps.node-pm.outputs.frozenInstall }}

    - name: Lint
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: ${{ steps.node-pm.outputs.run }} lint

    - name: Typecheck
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: ${{ steps.node-pm.outputs.run }} typecheck

    - name: Test
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: ${{ steps.node-pm.outputs.run }} test:ci

    - name: Build
      shell: bash
      working-directory: ${{ inputs.plugin-directory }}
      run: ${{ steps.node-pm.outputs.run }} build

    # The action should end up with a dist/ folder, but if the working directory is not the root of the repo,
    # we need to copy the dist/ folder to the root of the repo.
    - name: Copy dist if needed
      run: |
        if [ "$PLUGIN_DIRECTORY" != "." ]; then
          mkdir -p dist
          cp -r $PLUGIN_DIRECTORY/dist/* dist/
        fi
      shell: bash
      if: inputs.plugin-directory != '.'
      env:
        PLUGIN_DIRECTORY: ${{ inputs.plugin-directory }}
