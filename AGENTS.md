# AGENTS.md

This file provides guidance to AI coding assistants (Claude Code, Cursor, etc.) when working with code in this repository.

## Overview

This repository contains reusable GitHub Actions workflows and actions for building, testing, and deploying Grafana plugins. It's primarily for Grafana Labs internal teams.

## Commands

```bash
make actionlint      # Lint all workflows (run before completing workflow changes)
make act-lint        # Lint Go code in tests/act/
make act-test        # Run Go tests (timeout: 1h)
make genreadme       # Regenerate examples/base/README.md (auto-generated, don't edit directly)
make mockdata        # Regenerate test mock data after modifying test plugins
make clean           # Clean all temporary files, node_modules, and dist folders
```

## Project Structure

### `.github/workflows/`
- **Reusable workflows**: `ci.yml`, `cd.yml` (main entry points for plugin users)
- **Internal to ci/cd**: `playwright.yml`, `playwright-docker.yml`, `check-release-channel.yml`
- **This repo only**: `pr-checks-*`, `release-please-*`

### `actions/`
- **`actions/internal/`**: Actions used internally by ci.yml/cd.yml. NOT for direct user use.
- **`actions/plugins/`**: Standalone reusable actions users can use directly. Each has its own release tag.

### `tests/`
- **`tests/act/`**: Go testing framework using nektos/act in Docker
- **`tests/simple-*`**: Dummy Grafana plugins used by tests
- **`tests/act/mockdata/`**: Pre-built plugin artifacts for fast test execution

### `examples/`
- `examples/base/`: Core examples. README is auto-generated by `genreadme.go`
- `examples/extra/`: Additional helper examples

## GitHub Actions Rules

### Pin External Actions to Commit SHAs
```yaml
# Correct
uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.2.2

# Wrong
uses: actions/checkout@v4
```

### Use @main for Same-Repo References
```yaml
uses: grafana/plugin-ci-workflows/.github/workflows/ci.yml@main
uses: grafana/plugin-ci-workflows/actions/internal/plugins/setup@main
```
The release process automatically switches references to tagged versions.

### Never Interpolate GitHub Expressions in Shell Scripts
```yaml
# Dangerous - shell injection
- run: echo "${{ inputs.value }}"

# Safe - use env vars
- run: echo "${VALUE}"
  env:
    VALUE: ${{ inputs.value }}
```
**Exception:** Safe contexts (like `github.action`, `github.event_name`) may be used in `if:` conditions, but always use env vars in `run:` blocks.

### Runner Labels
Never use `ubuntu-latest`. Use self-hosted runners:
- ARM (preferred): `ubuntu-arm64-small`, `ubuntu-arm64`, `ubuntu-arm64-large`, `ubuntu-arm64-xlarge`, `ubuntu-arm64-2xlarge`
- x64 (when needed): `ubuntu-x64-small`, `ubuntu-x64`, `ubuntu-x64-large`
- Add `-io` suffix for I/O intensive workloads

### Complex Logic
Use `actions/github-script` instead of complex bash:
```yaml
- uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
  with:
    script: |
      const value = process.env.INPUT_VALUE;
      core.setOutput('result', computedValue);
  env:
    INPUT_VALUE: ${{ inputs.value }}
```

### Common Patterns

**Safe Input Handling:**
```yaml
- run: |
    case "${DEPLOY_ENV}" in
      dev|ops|prod-canary|prod)
        echo "Deploying to ${DEPLOY_ENV}"
        ;;
      *)
        echo "Invalid environment: ${DEPLOY_ENV}"
        exit 1
        ;;
    esac
  env:
    DEPLOY_ENV: ${{ inputs.environment }}
```

**Conditional Steps (safe in `if:` context):**
```yaml
- name: Deploy to production
  if: inputs.environment == 'prod'
  run: ./deploy.sh
  env:
    TARGET_ENV: ${{ inputs.environment }}
```

**Matrix Strategy:**
```yaml
strategy:
  matrix:
    os: [linux, darwin, windows]
    arch: [amd64, arm64]
steps:
  - run: echo "Building for ${TARGET_OS}/${TARGET_ARCH}"
    env:
      TARGET_OS: ${{ matrix.os }}
      TARGET_ARCH: ${{ matrix.arch }}
```

## Release Process

Uses release-please with separate versioning:
- Main workflows: `ci-cd-workflows/vX.Y.Z`
- Each action in `actions/plugins/`: its own version tag

When adding a new shared workflow (internal to ci/cd), add its path to the `switch-references` step in:
- `.github/workflows/pr-checks-workflow-references.yml`
- `.github/workflows/release-please-pr-update-tagged-references.yml`
- `.github/workflows/release-please-restore-rolling-release.yml`

When adding a new user-facing action in `actions/plugins/`, update `release-please-config.json`.

## Testing Framework

The Go testing framework in `tests/act/` is **work in progress**. Do not write new tests unless explicitly requested.

Uses: testify for assertions, nektos/act in Docker, pre-built mockdata for speed.

When modifying test plugins in `tests/simple-*`, run `make mockdata` to regenerate mock data.

### Go Testing Rules

**Use testify, not stdlib testing:**
```go
import "github.com/stretchr/testify/require"

func TestSomething(t *testing.T) {
    result, err := DoSomething()
    require.NoError(t, err)
    require.Equal(t, expected, result)
}
```

**Use table-driven tests:**
```go
for _, tc := range []testCase{
    {name: "case1", input: "a", expected: "A"},
    {name: "case2", input: "b", expected: "B"},
} {
    t.Run(tc.name, func(t *testing.T) {
        t.Parallel()
        require.Equal(t, tc.expected, Transform(tc.input))
    })
}
```

**Run independent tests in parallel** with `t.Parallel()`.

**Workflow testing patterns:** See existing tests for current API usage:
- [main_smoke_test.go](tests/act/main_smoke_test.go) - Basic CI workflow tests
- [main_cd_test.go](tests/act/main_cd_test.go)  More complex CD workflow tests, with mocking and test workflow manipulation
- [internal/workflow/ci/ci.go](tests/act/internal/workflow/ci/ci.go) - CI workflow helpers
- [internal/act/act.go](tests/act/internal/act/act.go) - Runner implementation