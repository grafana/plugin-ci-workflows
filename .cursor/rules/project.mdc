---
title: Plugin CI Workflows Project Rules
description: Guidelines for contributing to the plugin-ci-workflows repository
globs:
  - "**/*"
alwaysApply: true
---

# Plugin CI/CD Workflows Project

This repository contains reusable GitHub Actions workflows and actions for building, testing, linting, and deploying Grafana plugins developed internally at Grafana Labs.

## Project Structure

### `.github/workflows/`
Contains **both** internal repo workflows and shared/reusable workflows:

| Workflow | Type | Description |
|----------|------|-------------|
| `ci.yml` | **Reusable** | Main CI workflow for plugin users |
| `cd.yml` | **Reusable** | Main CD workflow for plugin users |
| `playwright.yml` | Internal to ci.yml | E2E testing (users should not use it directly) |
| `playwright-docker.yml` | Internal to ci.yml | E2E testing with Docker (users should not use it directly) |
| `pr-checks-*` | Internal | Linting, validation for this repo |
| `release-please-*` | Internal | Release automation for this repo |

### `actions/`
Contains shared actions:

- **`actions/internal/`** — Actions used by the reusable workflows, such as `ci.yml` and `cd.yml`. Coupled to workflow internals. **NOT for direct user use.**
- **`actions/plugins/`** — Standalone reusable actions for users. Can be used alongside the reusable workflows.

### `examples/`
Documentation examples showing how to use the reusable workflows:
- `examples/base/` — Core examples with `genreadme.go` that generates the README
- `examples/extra/` — Additional helper examples

**Important:** The file `examples/base/README.md` is **auto-generated** by `examples/base/genreadme.go`. Do not edit it directly. When making any changes to files in `examples/base/**/*`, regenerate the README:

```bash
make genreadme
```

### `tests/`
Testing code:
- **`tests/act/`** — Go tests using nektos/act in Docker for workflow testing
- **`tests/simple-*`** — Dummy Grafana plugins used by tests
- **`tests/act/mockdata/`** — Pre-generated files (built plugins, zip packages) for fast test execution

**Important:** When making changes to any dummy test plugin in `tests/*` (except to the testing framework, itself in `tests/act`), regenerate the mock data:

```bash
make mockdata
```

### `scripts/`
Helper scripts used by the Makefile.

---

## GitHub Actions Workflow Rules

### 1. Pin External Actions to Commits
For security (zizmor), always pin external actions to a specific commit SHA with a semver comment:

**Bad:**
```yaml
uses: actions/checkout@v4
```

**Good:**
```yaml
uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.2.2
```

### 2. Use `@main` for Same-Repo References
When referencing workflows or actions from this repository, always use `@main`:

```yaml
uses: grafana/plugin-ci-workflows/.github/workflows/ci.yml@main
uses: grafana/plugin-ci-workflows/actions/internal/plugins/setup@main
```

### 3. Never Use GitHub Expressions in Bash Scripts
GitHub expressions in bash are vulnerable to shell injection. Use environment variables instead:

**Bad:**
```yaml
- run: |
    if [ "${{ inputs.value }}" == "foo" ]; then
      echo "match"
    fi
```

**Good:**
```yaml
- run: |
    if [ "${MY_VALUE}" == "foo" ]; then
      echo "match"
    fi
  env:
    MY_VALUE: ${{ inputs.value }}
```

### 4. Use Self-Hosted Runner Labels
Never use `ubuntu-latest`. Always use our self-hosted runner labels:

**Preferred (ARM - cheaper):**
- `ubuntu-arm64-small` — For simple bash scripts
- `ubuntu-arm64` — Standard workloads
- `ubuntu-arm64-large`, `ubuntu-arm64-xlarge`, `ubuntu-arm64-2xlarge` — Heavy workloads
- Add `-io` suffix for I/O intensive workloads

**x64 runners (when ARM not suitable):**
- `ubuntu-x64-small`, `ubuntu-x64`, `ubuntu-x64-large`, etc.

### 5. Use JavaScript for Complex Logic
For complex logic in workflow steps, use `actions/github-script` instead of bash:

```yaml
- uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
  with:
    script: |
      const value = process.env.INPUT_VALUE;
      // Complex logic here using JavaScript
      core.setOutput('result', computedValue);
  env:
    INPUT_VALUE: ${{ inputs.value }}
```

### 6. Run actionlint Before Finishing
Always run `actionlint` in the repo root before completing workflow changes to catch issues early.

---

## Adding New Components

### Adding a New Internal Action
1. Create the action in `actions/internal/`
2. Reference it from the workflows using `@main`

### Adding a New Reusable Action (for users)
1. Create the action in `actions/plugins/`
2. Update `release-please-config.json` to include the new action path
3. The action will get its own version tags via release-please

### Adding a New Shared Workflow (internal to ci/cd)
If adding a workflow that's part of `ci.yml`/`cd.yml` but in a separate file (like `playwright.yml`):

1. Create the workflow file
2. Add the path to `switch-references` step in **all three** of these files:
   - `.github/workflows/pr-checks-workflow-references.yml`
   - `.github/workflows/release-please-pr-update-tagged-references.yml`
   - `.github/workflows/release-please-restore-rolling-release.yml`

---

## Release Process

- Uses **release-please** for automated releases
- Versions are git tags that users can pin to
- Separate tags for:
  - Main workflows (`ci-cd-workflows/vX.Y.Z`)
  - Each reusable action in `actions/plugins/`

The release process:
1. `release-please-pr-update-tagged-references.yml` updates references to point to the new tag
2. Release-please creates the git tag
3. `release-please-restore-rolling-release.yml` switches references back to `@main`

---

## Testing

The testing framework in `tests/act/` uses:
- **Go** with **testify** for assertions
- **nektos/act** running in Docker to execute workflows
- Mock data in `tests/act/mockdata/` (generated via Makefile commands)

**Note:** The testing framework is work in progress. Do not write new tests unless explicitly requested.

---

## Quick Reference

| Task | Command / Location |
|------|----------|
| Add internal action | `actions/internal/` |
| Add user-facing action | `actions/plugins/` + update `release-please-config.json` |
| Add workflow example | `examples/base/` or `examples/extra/` |
| Add test plugin | `tests/simple-*` |
| Regenerate examples README | `make genreadme` |
| Regenerate test mock data | `make mockdata` |
| Lint Go code | `make act-lint` |
| Lint workflows | `make actionlint` |
