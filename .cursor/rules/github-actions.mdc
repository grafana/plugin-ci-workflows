---
title: GitHub Actions Development Rules
description: Security and style rules for GitHub Actions workflows and actions
globs:
  - ".github/workflows/**/*.yml"
  - ".github/workflows/**/*.yaml"
  - "actions/**/*.yml"
  - "actions/**/*.yaml"
alwaysApply: false
---

# GitHub Actions Development Rules

## Security Requirements

### Pin All External Actions to Commit SHAs
Every external action must be pinned to a full commit SHA with a version comment:

```yaml
# ✅ Correct
uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.2.2
uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fcd011dab8a0b193b # v4.2.0
uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0

# ❌ Wrong - vulnerable to supply chain attacks
uses: actions/checkout@v4
uses: actions/checkout@v4.2.2
```

### Never Interpolate GitHub Expressions in Shell Scripts
GitHub expressions (`${{ }}`) in shell scripts are vulnerable to injection attacks:

```yaml
# ❌ DANGEROUS - shell injection vulnerability
- run: |
    echo "Branch: ${{ github.head_ref }}"
    if [ "${{ inputs.environment }}" = "prod" ]; then
      deploy
    fi

# ✅ SAFE - use environment variables
- run: |
    echo "Branch: ${BRANCH}"
    if [ "${ENVIRONMENT}" = "prod" ]; then
      deploy
    fi
  env:
    BRANCH: ${{ github.head_ref }}
    ENVIRONMENT: ${{ inputs.environment }}
```

**Exception:** Safe contexts that are validated by GitHub (like `github.action`, `github.event_name`) may be used directly in conditionals (`if:`), but ALWAYS prefer env vars in `run:` blocks.

---

## Runner Selection

Use self-hosted runner labels. **Never use `ubuntu-latest`**.

### Prefer ARM Runners (Cheaper)
```yaml
runs-on: ubuntu-arm64-small   # Simple scripts, quick tasks
runs-on: ubuntu-arm64         # Standard workloads
runs-on: ubuntu-arm64-large   # Heavier workloads
runs-on: ubuntu-arm64-xlarge  # Very heavy workloads
runs-on: ubuntu-arm64-2xlarge # Maximum resources
```

### For I/O Intensive Workloads
Add `-io` suffix:
```yaml
runs-on: ubuntu-arm64-io
runs-on: ubuntu-arm64-large-io
```

### x64 Runners (When ARM Not Suitable)
```yaml
runs-on: ubuntu-x64-small
runs-on: ubuntu-x64
runs-on: ubuntu-x64-large
# etc.
```

---

## Complex Logic: Use JavaScript

For anything beyond simple shell commands, use `actions/github-script`:

```yaml
- name: Complex logic example
  uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
  id: compute
  with:
    script: |
      const fs = require('fs');
      
      // Access inputs via environment variables (safe!)
      const environment = process.env.ENVIRONMENT;
      const branch = process.env.BRANCH;
      
      // Complex logic
      const isProduction = environment === 'prod';
      const allowedEnvs = ['dev', 'ops', 'prod-canary', 'prod'];
      const environments = environment.split(',')
        .map(e => e.trim())
        .filter(e => allowedEnvs.includes(e));
      
      // Set outputs
      core.setOutput('environments', JSON.stringify(environments));
      core.setOutput('is-production', String(isProduction));
      
      // Fail the step if needed
      if (environments.length === 0) {
        core.setFailed('No valid environments specified');
      }
  env:
    ENVIRONMENT: ${{ inputs.environment }}
    BRANCH: ${{ github.ref_name }}
```

---

## Internal References

When referencing workflows or actions from this repository, always use `@main`:

```yaml
# ✅ Correct - uses @main for same-repo references
uses: grafana/plugin-ci-workflows/.github/workflows/ci.yml@main
uses: grafana/plugin-ci-workflows/actions/internal/plugins/setup@main

# ❌ Wrong - don't use tags for internal references
uses: grafana/plugin-ci-workflows/.github/workflows/ci.yml@v1.0.0
```

The release process automatically switches references to tagged versions before creating releases.

---

## Validation

Before completing any workflow changes:

1. Run `make actionlint` in the repository root
2. Fix all reported issues
3. Verify the workflow syntax is valid

---

## Common Patterns

### Safe Input Handling
```yaml
- name: Process inputs safely
  run: |
    if [ -n "${PLUGIN_DIR}" ]; then
      cd "${PLUGIN_DIR}"
    fi
    
    case "${DEPLOY_ENV}" in
      dev|ops|prod-canary|prod)
        echo "Deploying to ${DEPLOY_ENV}"
        ;;
      *)
        echo "Invalid environment: ${DEPLOY_ENV}"
        exit 1
        ;;
    esac
  env:
    PLUGIN_DIR: ${{ inputs.plugin-directory }}
    DEPLOY_ENV: ${{ inputs.environment }}
```

### Conditional Steps with Safe Expressions
```yaml
# Safe in 'if:' conditions (outside shell context)
- name: Deploy to production
  if: inputs.environment == 'prod'
  run: ./deploy.sh
  env:
    TARGET_ENV: ${{ inputs.environment }}
```

### Matrix Strategy with Outputs
```yaml
strategy:
  matrix:
    os: [linux, darwin, windows]
    arch: [amd64, arm64]
steps:
  - run: |
      echo "Building for ${TARGET_OS}/${TARGET_ARCH}"
    env:
      TARGET_OS: ${{ matrix.os }}
      TARGET_ARCH: ${{ matrix.arch }}
```
